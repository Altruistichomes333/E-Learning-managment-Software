{% load static %}
<!doctype html>
<html lang="en">
  <head>
   
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

 
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
    <script src="https://kit.fontawesome.com/fbfe7ccd16.js" crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
    <link rel="stylesheet" href="{% static 'style/myform.css' %}">
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <title> Login Portal </title>


    <style>

      .fa-forward {
        position: absolute;
        top: 88%;
        right: 30%;
        font-size: 20px;
        display: flex;
        align-items: center;
        color: rgb(255, 255, 255);
      }
    </style>

  </head>
  <body>


   
       
            <div class="card-body" style="background-color: #009688;">
                
                    
              {% include  'message.html' %}
                   
                    <div class="container message  ">
                   
                    
                    <div class="form" style="
                    margin-top: 110px;
                "> 
                    <form action=" " id="formid" method="post" autocomplete="off">
                      {% csrf_token %}
                      <h1>Login Portal</h1>
                       
                      <div class="card-text">
                <label for="" class="form-label">Whatsapp Number:</label>
                <div class="" style="position: relative">
                  <input
                    type="tel"
                    minlength="10"
                    maxlength="11"
                    name="phone"
                    style="padding-left: 50px"
                    id="phone"
                    class="form-control"
                    placeholder="Enter Whatsapp No "
                    required />
                  <div class="icon">
                    <i
                      class="fa-brands fa-whatsapp"
                      style="position: absolute; top: 0px; left: 0px"></i>
                  </div>
                </div>
              </div>

               <div class="card-text">
              <label for="" class="form-label">Enter Password:</label>
              <div class="" style="position: relative">
                <input
                  type="password"
                  name="password"
                  style="padding-left: 50px"
                  id="password"
                  class="form-control"
                  placeholder="password "
                  required />
                <div class="icon">
                  <i
                    class="fa-solid fa-lock"
                    style="position: absolute; top: 0px; left: 0px"></i>
                </div>
              </div>
            </div>

            <div class="btn d-grid mt-3">
              <input type="submit" id="login-button" value="Proceed" class="btn btn-primary  ">
                  <div class="icon-btn">
                      <i class="fa-solid fa-forward"></i>
                  </div>
            </div>
                      
                       


          </form>
        </div>
      </div>
   
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js" integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN" crossorigin="anonymous"></script>
    
    <script>
  $(document).ready(function() {
      // Initialize form validation
      $("#login-form").validate({
          rules: {
              phone: {
                  required: true,
                  minlength: 10,
                  maxlength: 11,
                  digits: true // Ensures only numbers are entered
              },
              password: {
                  required: true
              }
          },
          messages: {
              phone: {
                  required: "Please enter your Whatsapp number",
                  minlength: "Phone number must be at least 10 digits",
                  maxlength: "Phone number must be at most 11 digits",
                  digits: "Only numeric values are allowed"
              },
              password: {
                  required: "Please enter your password"
              }
          }
      });

      // Login form submission via AJAX
      $("#login-form").submit(function(e) {
          e.preventDefault();

          if (!$("#login-form").valid()) return; // Prevent submission if invalid

          let submitBtn = $("#login-button"); // Assuming your button has this ID
          submitBtn.prop("disabled", true).val("Logging in..."); // Disable button

          $.ajax({
              type: "POST",
              url: "{% url 'login' %}",
              data: $(this).serialize(),
              headers: { "X-CSRFToken": getCSRFToken() }, // Fetch CSRF token correctly
              success: function(response) {
                  if (response.redirect_url) {
                      window.location.href = response.redirect_url; // Redirect to dashboard
                  } else {
                      window.location.href = "/dashboard/"; // Default redirect
                  }
              },
              error: function(xhr) {
                  let errorMessage = "Invalid phone number or password";
                  if (xhr.responseJSON && xhr.responseJSON.error) {
                      errorMessage = xhr.responseJSON.error;
                  }
                  swal("Error", errorMessage, "error");
              },
              complete: function() {
                  submitBtn.prop("disabled", false).text("Login"); // Re-enable button
              }
          });
      });

      // Function to get CSRF token from cookies
      function getCSRFToken() {
          let cookieValue = null;
          if (document.cookie && document.cookie !== '') {
              let cookies = document.cookie.split(';');
              for (let i = 0; i < cookies.length; i++) {
                  let cookie = cookies[i].trim();
                  if (cookie.startsWith("csrftoken=")) {
                      cookieValue = cookie.substring("csrftoken=".length, cookie.length);
                      break;
                  }
              }
          }
          return cookieValue;
      }
  });
</script>



  </body>

  

</html>